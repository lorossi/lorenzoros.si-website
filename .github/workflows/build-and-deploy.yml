name: Build and Deploy Website

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allows manual triggering

env:
  SETTINGS_FILE: "ci-settings.toml"
  KEY_FILENAME: "ci-key.key"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          cd python_scripts
          pip install -r requirements.txt

      - name: Set up CI environment
        run: |
          cd python_scripts
          python3 ci/environment.py --setup --settings "$SETTINGS_FILE" --key-filename "$KEY_FILENAME"

      - name: Build and deploy website
        run: |
          cd python_scripts
          python3 build.py -HD --settings "$SETTINGS_FILE"
        env:
          SCRAPER_USERNAME: ${{ secrets.SCRAPER_USERNAME }}
          SCRAPER_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOYER_USERNAME: ${{ secrets.DEPLOYER_USERNAME }}
          DEPLOYER_PASSWORD: ${{ secrets.DEPLOYER_PASSWORD }}
          DEPLOYER_REMOTE_PATH: ${{ secrets.DEPLOYER_REMOTE_PATH }}
          DEPLOYER_KEY_CONTENT: ${{ secrets.DEPLOYER_KEY_CONTENT }}

      - name: Tear down CI environment
        if: always()
        run: |
          cd python_scripts
          python3 ci/environment.py --teardown --settings "$SETTINGS_FILE" --key-filename "$KEY_FILENAME"
